<div class="missions-container">
    <div class="page-header">
        <h1 class="page-title">Missions</h1>
        <p class="page-subtitle">Search and browse available missions</p>
    </div>

    <mat-card class="filter-card">
        <mat-card-content>
            <div class="filter-form">
                <div class="filter-group">
                    <mat-icon class="search-icon">search</mat-icon>
                    <span class="filter-label">Search Missions</span>
                </div>

                <div class="filter-inputs">
                    <mat-form-field appearance="outline" class="search-field">
                        <mat-label>Mission Name</mat-label>
                        <input matInput [ngModel]="filter().name" (ngModelChange)="updateFilter({name: $event})"
                            placeholder="Mission Name">
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="status-field">
                        <mat-label>Status</mat-label>
                        <mat-select [ngModel]="filter().status" (ngModelChange)="updateFilter({status: $event})">
                            <mat-option value="Open">Open</mat-option>
                            <mat-option value="InProgress">In Progress</mat-option>
                            <mat-option value="Completed">Completed</mat-option>
                            <mat-option value="Failed">Failed</mat-option>
                        </mat-select>
                    </mat-form-field>

                    <button mat-raised-button class="search-btn" (click)="onSubmit()">
                        <mat-icon>search</mat-icon> Search
                    </button>
                </div>
            </div>
        </mat-card-content>
    </mat-card>

    <div class="mission-table-container">
        @if(filteredMissions().length) {
        <table class="mission-table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Description</th>
                    <th>Chief</th>
                    <th>Number of Crew</th>
                    <th>Status</th>
                    <th>Deadline</th>
                    <th>Created at</th>
                    <th>Updated at</th>
                    @if(isSignin()) {
                    <th class="action-header">Actions</th>
                    }
                </tr>
            </thead>
            <tbody>
                @for (mission of filteredMissions(); track mission.id) {
                <tr>
                    <td class="name-cell">{{ mission.name }}</td>
                    <td class="description-cell">{{ mission.description || '-' }}</td>
                    <td>{{ mission.chief_display_name }}</td>
                    <td class="crew-cell" (click)="openCrewDialog(mission)">
                        <span class="crew-count-link">{{ mission.crew_count }} / {{ mission.max_crew }}</span>
                    </td>
                    <td>
                        <span class="status-badge"
                            [ngClass]="(mission.status === 'Open' && getCountdown(mission.deadline).isExpired) ? 'failed' : mission.status.toLowerCase()">
                            {{ (mission.status === 'Open' && getCountdown(mission.deadline).isExpired) ? 'FAILED' :
                            mission.status.toUpperCase() }}
                        </span>
                    </td>
                    <td class="deadline-cell">
                        @if (mission.status === 'Open') {
                        @if (mission.deadline) {
                        <span class="countdown" [class.expired]="getCountdown(mission.deadline).isExpired"
                            [class.urgent]="getCountdown(mission.deadline).isUrgent">
                            {{ getCountdown(mission.deadline).text }}
                        </span>
                        } @else if (mission.duration) {
                        <span class="status-text muted">
                            {{ getDurationDisplay(mission.duration) }}
                        </span>
                        } @else {
                        <span class="status-text muted">-</span>
                        }
                        } @else if (mission.status === 'InProgress') {
                        <span class="countdown" [class.expired]="getCountdown(mission.deadline).isExpired"
                            [class.urgent]="getCountdown(mission.deadline).isUrgent">
                            {{ getCountdown(mission.deadline).text }}
                        </span>
                        } @else if (mission.status === 'Completed') {
                        <span class="status-text completed">Ended</span>
                        } @else {
                        <span class="status-text failed">Failed</span>
                        }
                    </td>
                    <td>{{ mission.created_at | date:'MM/dd/yy, h:mm a' }}</td>
                    <td>{{ mission.updated_at | date:'MM/dd/yy, h:mm a' }}</td>
                    <td class="action-cell">
                        @if(isSignin()) {
                        @if(mission.chief_id === currentUserId()) {
                        <span class="owned-label">Owner</span>
                        } @else {
                        @if (mission.status === 'Open' && !getCountdown(mission.deadline).isExpired) {
                        <a class="join-link" (click)="onJoin(mission.id)">Join</a>
                        } @else {
                        <span class="status-text muted">
                            {{ mission.status === 'InProgress' ? 'In Progress' :
                            mission.status === 'Completed' ? 'Completed' :
                            (mission.status === 'Failed' || getCountdown(mission.deadline).isExpired) ? 'Closed' : '-'
                            }}
                        </span>
                        }
                        }
                        } @else {
                        <span class="signin-required">Sign in to Join</span>
                        }
                    </td>
                </tr>
                }
            </tbody>
        </table>
        } @else {
        <div class="no-missions">
            <mat-icon>search_off</mat-icon>
            <p class="no-missions-text">No missions found</p>
            <p>Try a different search or create a new mission</p>
        </div>
        }
    </div>

    <!-- Crew Members Dialog -->
    @if (showCrewDialog()) {
    <div class="dialog-overlay" (click)="closeCrewDialog()">
        <div class="dialog-container crew-dialog" (click)="$event.stopPropagation()">
            <div class="dialog-header crew">
                <h2>Crew Members</h2>
                <button mat-icon-button class="close-btn" (click)="closeCrewDialog()">
                    <mat-icon>close</mat-icon>
                </button>
            </div>
            <div class="dialog-content">
                <div class="crew-mission-info">
                    <span class="mission-name">{{ crewDialogMission()?.name }}</span>
                    <span class="crew-count-badge">{{ crewMembers().length }} / {{ crewDialogMission()?.max_crew
                        }}</span>
                </div>

                @if (isLoadingCrew()) {
                <div class="loading-crew">
                    <mat-icon class="spin">sync</mat-icon>
                    <span>Loading crew members...</span>
                </div>
                } @else if (crewMembers().length === 0) {
                <div class="no-crew">
                    <mat-icon>group_off</mat-icon>
                    <span>No crew members yet</span>
                </div>
                } @else {
                <div class="crew-list">
                    @for (member of crewMembers(); track member.id) {
                    <div class="crew-member-item">
                        <div class="member-avatar">
                            @if (member.avatar_url) {
                            <img [src]="member.avatar_url" [alt]="member.display_name" crossorigin="anonymous">
                            } @else {
                            <mat-icon>person</mat-icon>
                            }
                        </div>
                        <div class="member-info">
                            <span class="member-name">{{ member.display_name }}</span>
                            <span class="member-username">&#64;{{ member.username }}</span>
                        </div>
                    </div>
                    }
                </div>
                }
            </div>
            <div class="dialog-actions">
                <button mat-button class="cancel-btn" (click)="closeCrewDialog()">Close</button>
            </div>
        </div>
    </div>
    }
</div>